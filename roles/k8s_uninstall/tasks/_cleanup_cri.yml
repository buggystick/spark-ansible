---
# Shared task: force-clean containerd/CRI k8s workloads and unmount kubelet mounts.
- name: Force-clean containerd k8s workload and unmount kubelet mounts
  ansible.builtin.shell: |
    set -Eeuo pipefail
    removed_any=0

    # Kill/delete any running tasks in containerd k8s namespace
    for id in $(ctr -n k8s.io tasks ls -q 2>/dev/null || true); do
      ctr -n k8s.io tasks kill -s KILL "$id" 2>/dev/null || true
      ctr -n k8s.io tasks delete "$id" 2>/dev/null || true
      removed_any=1
    done

    # Delete any containers in containerd k8s namespace
    for id in $(ctr -n k8s.io containers ls -q 2>/dev/null || true); do
      ctr -n k8s.io containers delete "$id" 2>/dev/null || true
      removed_any=1
    done

    # Remove CRI containers/pods if CRI still lists any (safe if none)
    if crictl ps -aq >/dev/null 2>&1; then
      conts="$(crictl ps -aq || true)"
      if [ -n "${conts:-}" ]; then
        crictl rm --force $conts 2>/dev/null || true
        removed_any=1
      fi
    fi
    if crictl pods -aq >/dev/null 2>&1; then
      pods="$(crictl pods -aq || true)"
      if [ -n "${pods:-}" ]; then
        crictl rmp --force $pods 2>/dev/null || true
        removed_any=1
      fi
    fi

    # Lazy-unmount any kubelet mounts
    mnts="$(mount | awk '/\/var\/lib\/kubelet/ {print $3}' || true)"
    if [ -n "${mnts:-}" ]; then
      umount -l ${mnts} 2>/dev/null || true
      removed_any=1
    fi

    # Emit a marker if we want to track changes and something was removed
    if [ "{{ (track_changes | default(false) | bool) | ternary('true','false') }}" = "true" ] && [ "$removed_any" -eq 1 ]; then
      echo "CLEANED_CONTAINERD_OR_MOUNTS"
    fi
  args:
    executable: /bin/bash
  register: _cleanup_cri_result
  changed_when: >-
    {{ (track_changes | default(false) | bool) and ('CLEANED_CONTAINERD_OR_MOUNTS' in _cleanup_cri_result.stdout) }}
  failed_when: false
