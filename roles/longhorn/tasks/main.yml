---
# roles/longhorn/tasks/main.yml
# Idempotent Longhorn install/upgrade using Helm.
# - Uses KUBECONFIG=/etc/kubernetes/admin.conf for all kubectl/helm calls
# - Ensures the Longhorn data directory exists on *every* node
# - Installs/updates Longhorn and waits for readiness

- name: Ensure Helm installer script is present (primary only)
  copy:
    src: get-helm-3.sh
    dest: /tmp/get-helm-3.sh
    mode: '0755'
  when: "'primary' in group_names"

- name: Install Helm (primary only)
  command: bash /tmp/get-helm-3.sh
  args:
    creates: /usr/local/bin/helm
  when: "'primary' in group_names"

- name: Wait for API server by listing default Namespace (primary only)
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Namespace
    name: default
    kubeconfig: "{{ k8s_auth_kubeconfig }}"
  register: _apiready
  retries: 30
  delay: 2
  until: _apiready.resources is defined and (_apiready.resources | length) > 0
  changed_when: false
  when: "'primary' in group_names"

# Ensure the Longhorn data path exists on *every* node
- name: Build list of all nodes
  set_fact:
    _all_nodes: "{{ (groups['primary'] | default([])) + (groups['workers'] | default([])) }}"
  run_once: true

- name: Ensure Longhorn data dir exists on every node
  file:
    path: "{{ longhorn_data_dir }}"
    state: directory
    mode: '0755'
  delegate_to: "{{ item }}"
  with_items: "{{ _all_nodes }}"
  run_once: true
  become: true

- name: Label worker nodes for Longhorn eligibility (primary only)
  ansible.builtin.command: >
    kubectl --kubeconfig {{ k8s_auth_kubeconfig }}
    label node {{ item }} {{ longhorn_node_selector_key }}={{ longhorn_node_selector_value }} --overwrite
  with_items: "{{ groups['workers'] | default([]) }}"
  when: "'primary' in group_names and (groups['workers'] | length) > 0"
  changed_when: true

# Helm repo + install
- name: Ensure Longhorn Helm repo configured (primary only)
  kubernetes.core.helm_repository:
    name: longhorn
    repo_url: https://charts.longhorn.io
    state: present
    force_update: true
    kubeconfig: "{{ k8s_auth_kubeconfig }}"
  when: "'primary' in group_names"

- name: Ensure longhorn-system namespace exists (primary only)
  kubernetes.core.k8s:
    kubeconfig: "{{ k8s_auth_kubeconfig }}"
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: longhorn-system
  when: "'primary' in group_names"

- name: Copy Longhorn Helm values (primary only)
  copy:
    src: longhorn-values.yaml
    dest: /tmp/longhorn-values.yaml
    mode: '0644'
  when: "'primary' in group_names"

- name: Install/upgrade Longhorn via Helm (primary only)
  kubernetes.core.helm:
    name: longhorn
    chart_ref: longhorn
    chart_repo_url: https://charts.longhorn.io
    release_namespace: longhorn-system
    create_namespace: false
    values_files:
      - /tmp/longhorn-values.yaml
    kubeconfig: "{{ k8s_auth_kubeconfig }}"
    wait: true
    wait_timeout: "1200s"
    state: present
  when: "'primary' in group_names"

# Wait for core Longhorn components to be ready
- name: Wait for longhorn-manager DaemonSet to be ready (primary only)
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: DaemonSet
    namespace: longhorn-system
    name: longhorn-manager
    kubeconfig: "{{ k8s_auth_kubeconfig }}"
  register: _lh_mgr
  until: _lh_mgr.resources | length > 0 and ((_lh_mgr.resources[0].status.numberReady | default(0)) >= (_lh_mgr.resources[0].status.desiredNumberScheduled | default(0)))
  retries: 60
  delay: 10
  changed_when: false
  when: "'primary' in group_names"

- name: Wait for longhorn-driver-deployer Deployment to be Available (primary only)
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    namespace: longhorn-system
    name: longhorn-driver-deployer
    kubeconfig: "{{ k8s_auth_kubeconfig }}"
    wait: true
    wait_sleep: 10
    wait_timeout: 1200
    wait_condition:
      type: Available
      status: "True"
  when: "'primary' in group_names"

- name: Copy Longhorn StorageClass manifest (primary only)
  copy:
    src: longhorn-storageclass.yaml
    dest: /tmp/longhorn-storageclass.yaml
    mode: '0644'
  when: "'primary' in group_names"
  run_once: true

- name: Ensure Longhorn StorageClass exists (primary only)
  kubernetes.core.k8s:
    kubeconfig: "{{ k8s_auth_kubeconfig }}"
    state: present
    src: /tmp/longhorn-storageclass.yaml
    apply: yes
  when: "'primary' in group_names"
  run_once: true
