- name: Read proxy.py content from role files
  ansible.builtin.set_fact:
    _proxy_py: "{{ lookup('file', role_path + '/files/proxy.py') }}"

- name: Ensure OpenAI proxy ConfigMap is present
  kubernetes.core.k8s:
    kubeconfig: /etc/kubernetes/admin.conf
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: openai-proxy-code
        namespace: default
      data:
        proxy.py: |
          {{ _proxy_py | indent(10) }}

- name: Render proxy deployment manifest
  ansible.builtin.template:
    src: proxy-deploy.yaml.j2
    dest: /tmp/openai-proxy.yaml
    mode: "0644"

- name: Apply proxy Deployment/Service
  kubernetes.core.k8s:
    kubeconfig: /etc/kubernetes/admin.conf
    state: present
    src: /tmp/openai-proxy.yaml
    apply: yes
