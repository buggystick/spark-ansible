---
- name: Ensure Open WebUI Helm repo configured
  kubernetes.core.helm_repository:
    name: open-webui
    repo_url: https://helm.openwebui.com
    state: present
    force_update: true
    kubeconfig: /etc/kubernetes/admin.conf

- name: Ensure openwebui namespace exists
  kubernetes.core.k8s:
    kubeconfig: /etc/kubernetes/admin.conf
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: openwebui

- name: Push values
  copy:
    src: "{{ playbook_dir }}/files/openwebui-values.yaml"
    dest: /tmp/openwebui-values.yaml

- name: Install/upgrade Open WebUI via Helm
  kubernetes.core.helm:
    name: open-webui
    chart_ref: open-webui
    chart_repo_url: https://helm.openwebui.com
    release_namespace: openwebui
    create_namespace: false
    values_files:
      - /tmp/openwebui-values.yaml
    kubeconfig: /etc/kubernetes/admin.conf
    wait: true
    wait_timeout: "600"
    state: present
