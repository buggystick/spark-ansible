---
- name: Create default ns
  command: kubectl create ns default
  failed_when: false
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

- name: Create models PVC (Longhorn RWX)
  copy:
    dest: /tmp/triton-models-pvc.yaml
    mode: '0644'
    content: |
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: triton-models
        namespace: default
      spec:
        accessModes: [ "ReadWriteMany" ]
        resources:
          requests:
            storage: 200Gi
        storageClassName: longhorn

- name: Apply models PVC
  command: kubectl apply -f /tmp/triton-models-pvc.yaml
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

- name: Copy Triton StatefulSet manifest
  copy:
    src: triton-ss.yaml
    dest: /tmp/triton-ss.yaml
    mode: '0644'

- name: Copy Triton Service manifest
  copy:
    src: triton-svc.yaml
    dest: /tmp/triton-svc.yaml
    mode: '0644'

- name: Apply Triton manifests
  shell: |
    kubectl apply -f /tmp/triton-svc.yaml
    kubectl apply -f /tmp/triton-ss.yaml
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
