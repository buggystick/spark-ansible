---
# roles/trtllm_build/tasks/main.yml
# Build TensorRT-LLM engines as a Kubernetes GPU Job (no host Docker required).

- name: Ensure default namespace exists
  kubernetes.core.k8s:
    kubeconfig: /etc/kubernetes/admin.conf
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: default

- name: Ensure Triton models PVC exists
  kubernetes.core.k8s:
    kubeconfig: /etc/kubernetes/admin.conf
    state: present
    definition:
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: triton-models
        namespace: default
      spec:
        accessModes: [ "ReadWriteMany" ]
        resources:
          requests:
            storage: 2000Gi
        storageClassName: longhorn

- name: Ensure Hugging Face token secret if provided
  when: (hostvars[inventory_hostname].hf_token | default('') | trim) | length > 0
  kubernetes.core.k8s:
    kubeconfig: /etc/kubernetes/admin.conf
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: hf-token
        namespace: default
      type: Opaque
      stringData:
        token: "{{ hostvars[inventory_hostname].hf_token | default('') }}"

- name: Render builder script ConfigMap manifest
  ansible.builtin.template:
    src: script-cm.yaml.j2
    dest: /tmp/trtllm-build-script-cm.yaml
    mode: '0644'

- name: Apply builder script ConfigMap
  kubernetes.core.k8s:
    kubeconfig: /etc/kubernetes/admin.conf
    state: present
    src: /tmp/trtllm-build-script-cm.yaml
    apply: yes

- name: Copy build Job manifest
  ansible.builtin.copy:
    src: trtllm-build-job.yaml
    dest: /tmp/trtllm-build-job.yaml
    mode: '0644'

- name: Delete previous Job if exists (to allow rerun)
  kubernetes.core.k8s:
    kubeconfig: /etc/kubernetes/admin.conf
    api_version: batch/v1
    kind: Job
    name: trtllm-build
    namespace: default
    state: absent
  changed_when: false
  failed_when: false

- name: Create build Job
  kubernetes.core.k8s:
    kubeconfig: /etc/kubernetes/admin.conf
    state: present
    src: /tmp/trtllm-build-job.yaml
    apply: yes

- name: Wait for Job completion (up to 12h for big models)
  kubernetes.core.k8s_info:
    api_version: batch/v1
    kind: Job
    name: trtllm-build
    namespace: default
    kubeconfig: /etc/kubernetes/admin.conf
    wait: true
    wait_sleep: 15
    wait_timeout: 43200
    wait_condition:
      type: Complete
      status: "True"
  register: _waitjob
  changed_when: false

- name: Get last Job pod
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: default
    kubeconfig: /etc/kubernetes/admin.conf
    label_selectors:
      - job-name=trtllm-build
  register: _jobpods
  changed_when: false

- name: Show job logs (last pod)
  when: _jobpods.resources | length > 0
  kubernetes.core.k8s_log:
    kubeconfig: /etc/kubernetes/admin.conf
    namespace: default
    name: "{{ _jobpods.resources | sort(attribute='metadata.creationTimestamp') | last | json_query('metadata.name') }}"
  register: _joblogs

- name: Show summary (debug)
  debug:
    msg: "{{ _joblogs.log | default('') | splitlines() | last(25) }}"
